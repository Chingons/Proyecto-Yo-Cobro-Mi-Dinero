{% extends "home.html"%}
{% block content %}

<div id="htmlrecibo">
    <div id="contenido-recibo">
        <div id="mensaje-pago">
            
            <p>¿Has recibido la suma de RD$:?</p>
            <p id="mensaje-total"></p>
            <p>Si no es así presione "CANCELAR", de lo contrario presione "PAGAR"</p>
            <a href="{{ url_for('pagar') }}">
                <input type="button" id="mensaje-total-pagar" value="PAGAR"> 
            </a>
            
            <input type="button" id="mensaje-total-cancelar" value="CANCELAR">
        </div>
        <input type="text" name="fecha_recibo" id="fecha_recibo" readonly>
        <input type="text" name="idrecibo" id="idrecibo" value="{{id}}" readonly>
        <input type="text" placeholder="Click aquí para mostrar sus clientes">
        <ul id="impresion-clientes-recibo">
        </ul>

        <table id="tabla-impresion-recibo">
            <tr>
                <th>ID</th>
                <th>FECHA</th>
                <th>MONTO ORIGINAL</th>
                <th>MONTO ACTUAL</th>
                <th>SELECCIONAR</th>
            </tr>
        </table>

        <h2>FACTURAS PROCESADAS</h2>

        <table id="tabla-facturas-pagar">
            <tr>
                <th>ID</th>
                <th>FECHA</th>
                <th>MONTO ORIGINAL</th>
                <th>MONTO ACTUAL</th>
                <th>REMOVER</th>
            </tr>
        </table>

        <label >TOTAL: <input type="text" value="0" id="input-total" readonly> </label>
        <div id="boton-error-recibo">
            <p id="error-procesar-facturas">FAVOR PROCESAR FACTURAS</p>
            <input type="button" value="GRABAR PAGO" onclick="comprobar();">

        </div>
        
    </div>
</div>


<script>
    var prueba;
    var facturas_procesadas=[];
    var fechas_procesadas = [];
    var montos_originales = [];
    var montos_actuales = [];

    var facturas_pagadas={}

    fecha_recibo = new Date().toLocaleDateString();
    document.getElementById("fecha_recibo").value = fecha_recibo;

    function conexion_json(){
        fetch('static/recibo.json')
        .then(devolucion => devolucion.json())
        .then(datos=> {
       var datos_json = datos
       var tamaño = Object.keys(datos_json).length;
        impresion(datos_json, tamaño);
    });

    }
    
     function impresion(vimprimir, tvariable){
        let ul_impresion = document.getElementById("impresion-clientes-recibo");
        
        for (let y=0; y<tvariable; y++){
            let li = document.createElement('li');
            let clickboton = document.createElement('button');
            clickboton.innerHTML = vimprimir[y]['nombre'] + " " + vimprimir[y]['telefono'] + " " 
            + vimprimir[y]['identificacion'] + " " + vimprimir[y]['direccion'];
            clickboton.addEventListener("click",function(){
                facturas(vimprimir[y]['facturas']);
            });
            li.appendChild(clickboton);
            ul_impresion.appendChild(li);
        }

     }

     function facturas(datos_facturas){
        let tabla_recibo = document.getElementById("tabla-impresion-recibo");
        let tamaño_tabla = tabla_recibo.rows.length;
        
        let tabla_proceso = document.getElementById("tabla-facturas-pagar");
        let tamaño_proceso = tabla_proceso.rows.length;
        facturas_procesadas = [];
        document.getElementById("input-total").value = "0";
        for (let o = tamaño_tabla -1; o>0; o--){
            tabla_recibo.deleteRow(o);}
        
        for (let h= tamaño_proceso -1; h>0; h--){
            tabla_proceso.deleteRow(h);}
        
        for (let p=0; p<datos_facturas.length; p++){
            let tr = document.createElement('tr');
            let td_id = document.createElement('td');
            let td_fecha = document.createElement('td');
            let td_monto_original = document.createElement('td');
            let td_monto_actual = document.createElement('td');
            let td_seleccionar = document.createElement('td');
            let boton_seleccionar = document.createElement("button");
            
            td_id.innerHTML = datos_facturas[p][0];
            td_fecha.innerHTML = datos_facturas[p][3];
            td_monto_original.innerHTML =  new Intl.NumberFormat('en-US').format(datos_facturas[p][4]);
            td_monto_actual.innerHTML = new Intl.NumberFormat('en-US').format(datos_facturas[p][5]);
            boton_seleccionar.innerHTML = "SELECCIONAR";
            boton_seleccionar.addEventListener("click", function(){
                facturas_recibo(datos_facturas[p]);
            });

            td_seleccionar.appendChild(boton_seleccionar);

            tr.appendChild(td_id);
            tr.appendChild(td_fecha);
            tr.appendChild(td_monto_original);
            tr.appendChild(td_monto_actual);
            tr.appendChild(td_seleccionar);

            tabla_recibo.appendChild(tr);} 
     }

     function facturas_recibo(recibidas){
        let fc_recibo = document.getElementById("tabla-facturas-pagar");
        

        if (facturas_procesadas.includes(recibidas[0])==true){

        }
        else {
            let input_total = document.getElementById("input-total");
            let value_input = input_total.value;
            let tomar_value_input = value_input.replace(",", "");
            let suma = recibidas[5] + Number(tomar_value_input);
            input_total.value = new Intl.NumberFormat('en-US').format(suma);
                facturas_procesadas.push(recibidas[0]);
                facturas_pagadas[recibidas[0]] = {"idfactura":recibidas[0], "fecha":recibidas[3], "monto_original":recibidas[4], "monto_actual":recibidas[5]};
                let tr = document.createElement("tr");
                let td_idr = document.createElement("td");
                let td_fechar = document.createElement("td");
                let td_monto_originalr = document.createElement("td");
                let td_monto_actualr = document.createElement("td");
                let remover = document.createElement("td");
                let boton_remover = document.createElement("button");


                tr.id = recibidas[0];
                td_idr.innerHTML = recibidas[0];
                td_fechar.innerHTML = recibidas[3];
                td_monto_originalr.innerHTML = new Intl.NumberFormat('en-US').format(recibidas[4]);
                td_monto_actualr.innerHTML = new Intl.NumberFormat('en-US').format(recibidas[5]);
                boton_remover.innerHTML = "REMOVER";
                boton_remover.addEventListener("click", function(){
                    let  remover_elemento = document.getElementById(recibidas[0]);
                    let input_total_resta = document.getElementById("input-total");
                    let value_input_resta = input_total_resta.value;
                    let tomar_value_input_resta = value_input_resta.replace(",", "");
                    let valor_restar = remover_elemento.getElementsByTagName("td")[3].innerHTML.replace(",","");
                    let resta = Number(tomar_value_input_resta) - Number(valor_restar);
                    input_total_resta.value = new Intl.NumberFormat('en-US').format(resta);
                    delete facturas_pagadas[recibidas[0]];
                  remover_elemento.remove();
                  const index = facturas_procesadas.indexOf(recibidas[0]);
                    if (index > -1) {
                    facturas_procesadas.splice(index, 1);
                    }
                    
                });
                remover.appendChild(boton_remover);
                tr.appendChild(td_idr);
                tr.appendChild(td_fechar);
                tr.appendChild(td_monto_originalr);
                tr.appendChild(td_monto_actualr);
                tr.appendChild(remover);
                fc_recibo.appendChild(tr);  
        }
    }

    function comprobar(){
        if (document.getElementById("input-total").value==0){
            document.getElementById("error-procesar-facturas").style.display="flex";
        }
        else{
            document.getElementById("error-procesar-facturas").style.display="none";
            document.getElementById("mensaje-pago").style.display="flex";
            document.getElementById("mensaje-total").innerHTML = document.getElementById("input-total").value;
            let boton_cancelar = document.getElementById("mensaje-total-cancelar");
            let boton_pagar = document.getElementById("mensaje-total-pagar");
            boton_cancelar.addEventListener("click",function(){
                document.getElementById("mensaje-pago").style.display="none";
            });

            boton_pagar.onclick= enviarjson();
        }
        
    }

    function enviarjson(){
        facturas_pagadas["fecha_recibo"] = document.getElementById("fecha_recibo").value;
        facturas_pagadas["monto_recibo"] = document.getElementById("input-total").value;
        fetch('http://localhost:5000/pagar', {
            headers : {
                'Content-Type' : 'application/json'
            },
            method : 'POST',
            body : JSON.stringify(facturas_pagadas)
        });
    }

        
     conexion_json();
</script>

{% endblock %}